<!DOCTYPE html>
<head>
  <title>Number Line</title>
  <meta charset="utf-8">
  <link href="jsPsych-7.3.0/css/jspsych.css" rel="stylesheet" type="text/css" />
  <link href="videos.css" rel="stylesheet" type="text/css" />
</head>
<body>
  <script type="text/javascript" src="src/config/constants.js"></script>
  <script type="text/javascript" src="src/config/setup-query-dict.js"></script>
  <script type="text/javascript" src="src/config/start-options.js"></script>
  <script type="text/javascript" src="src/config/feedback-options.js"></script>
  <script type="text/javascript" src="src/experiment-core.js"></script>

  <script type="text/javascript" src="src/utils/audio-utils.js"></script>
  <script type="text/javascript" src="src/utils/json-utils.js"></script>
  <script type="text/javascript" src="src/utils/html-utils.js"></script>
  <script type="text/javascript" src="src/utils/math-utils.js"></script>
  <script type="text/javascript" src="src/utils/saving-utils.js"></script>
  <script type="text/javascript" src="src/utils/js-utils.js"></script>

  <script type="text/javascript" src="src/gui/cardboard.js"></script>
  <script type="text/javascript" src="src/gui/tick.js"></script>
  <script type="text/javascript" src="src/gui/renderer.js"></script>
  <script type="text/javascript" src="src/gui/out-of-line-panel.js"></script>

  <script type="text/javascript" src="src/math/number-line.js"></script>
  <script type="text/javascript" src="src/math/rational.js"></script>
  <script type="text/javascript" src="src/math/error-flags.js"></script>

  <script type="text/javascript" src="src/instructions-template.js"></script>
  <script type="text/javascript" src="locale/localizer.js"></script>
  <script type="text/javascript" src="locale/fr-child.js"></script>
  <script type="text/javascript" src="locale/fr-adult.js"></script>

  <script type="text/javascript" src="config/gui-config.js"></script>

  <script type="text/javascript" src="jsPsych-7.3.0/jspsych.js"></script>
  <!-- <script type="text/javascript" src="jsPsych-7.3.0/plugins/plugin-html-keyboard-response.js"></script> -->
  <script type="text/javascript" src="jsPsych-7.3.0/plugins/extension-mouse-tracking.js"></script>
  <script type="text/javascript" src="jsPsych-7.3.0/plugins/plugin-instructions.js"></script>
  <script type="text/javascript" src="jsPsych-7.3.0/plugins/plugin-preload.js"></script>
  <script type="text/javascript" src="jsPsych-7.3.0/plugins/plugin-fullscreen.js"></script>
  <script type="text/javascript" src="jsPsych-7.3.0/plugins/plugin-survey-text.js"></script>
  <script type="text/javascript" src="jsPsych-7.3.0/plugins/plugin-video-keyboard-response.js"></script>
  <script type="text/javascript" src="src/plugin-number-to-line.js"></script>

  <!-- MAIN EXPERIMENT -->
  <script type="module">
    // We initialize jsPsych
    const jsPsych = initJsPsych({
      show_progress_bar: false,
      extensions: [{
        type: jsPsychExtensionMouseTracking,
      }],
      on_finish: function(data)
      {
        // SavingUtils.saveLocal(jsPsych, `${subjectID}_T${session}`);
        document.getElementById("jspsych-content").innerHTML = "<p>Tu as fini l'entra√Ænement !</p>";
      }
    });

    const localizer = new ChildFrenchLocalizer();

    // let EXPERIMENT_CONFIG = await fetch('./exp.json').then(r => r.json());
    let EXPERIMENT_CONFIG = await fetch(`./config/config_files/${queryDict.file}.json`).then(r => r.json());

    jsPsych.data.addProperties({'screenX': screen.width});
    jsPsych.data.addProperties({'screenY': screen.height});
    jsPsych.data.addProperties({'innerX': window.innerWidth});
    jsPsych.data.addProperties({'innerY': window.innerHeight});

    // We should also save the gui configuration
    jsPsych.data.addProperties({guiConfig: GUI_CONFIG})
    jsPsych.data.addProperties({'ID': "training", 'session': "training"});
    let timeline = [];

    if (!queryDict.debug){
      timeline.push({
        type: jsPsychFullscreen,
        message: localizer.getMessage("FULLSCREEN_PROMPT", [], "p"),
        button_label: localizer.getMessage("FULLSCREEN_LABEL"),
      });

      let instructionsTrial = ExperimentCore.createInstructionsTrial(
        Instructions.toHTMLPages(localizer),
        localizer.getMessage("NEXT"),
        localizer.getMessage("PREVIOUS"));

      timeline.push(instructionsTrial);
    }

    document.body.style.backgroundColor = GUI_CONFIG.BACKGROUND_COLOR;
    document.body.style.overflow = "hidden";


    // let flattenTargets = (targets) => targets.map(
    //   t => t.repetitions == undefined ? t.string : Array(t.repetitions).fill(t.string)
    // ).flat();

    timeline = timeline.concat(new ExperimentCore(jsPsych, EXPERIMENT_CONFIG, localizer, queryDict).generateTimeline());

    timeline.push(ExperimentCore.createInstructionsTrial(
      [localizer.getMessage("EXPERIENCE_ENDED", [], "p")],
      localizer.getMessage("TERMINATE")));
    console.log(timeline.length)
    jsPsych.run(timeline);
  </script>
</body>
